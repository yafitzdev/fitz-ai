# TEMPLATE: Epistemic Constraint Plugin
#
# Constraints evaluate whether retrieved chunks support answering a query.
# They enforce epistemic honesty - only allow confident answers when evidence supports it.
#
# INPUT:  query (str) - The user's question
#         chunks (Sequence[ChunkLike]) - Retrieved context chunks
#
# OUTPUT: ConstraintResult - Allow or deny a decisive answer
#
# REQUIRED:
#   - name: str property (unique identifier)
#   - apply() method with signature below
#
# ConstraintResult:
#   - ConstraintResult.allow() - Evidence supports answering
#   - ConstraintResult.deny(reason="...", signal="...") - Block decisive answer
#
# ChunkLike has:
#   - content: str (the chunk text)
#   - metadata: Dict (source info, etc.)

from dataclasses import dataclass
from typing import Sequence

from fitz_ai.core.chunk import ChunkLike
from fitz_ai.core.guardrails.base import ConstraintResult


@dataclass
class ConstraintTemplate:
    """
    Constraint plugins evaluate if chunks support answering a query.

    Replace 'ConstraintTemplate' with your plugin class name.
    Replace 'template_constraint' in the name property.
    """

    # Add configuration parameters here, for example:
    # min_chunks: int = 1
    # require_source: bool = True
    enabled: bool = True

    @property
    def name(self) -> str:
        """REQUIRED: Unique constraint identifier."""
        return "template_constraint"

    def apply(
        self,
        query: str,
        chunks: Sequence[ChunkLike],
    ) -> ConstraintResult:
        """
        Evaluate if chunks support answering the query.

        Args:
            query: The user's question.
            chunks: Retrieved context chunks.

        Returns:
            ConstraintResult.allow() if answer is safe.
            ConstraintResult.deny(reason, signal) if answer should be blocked.
        """
        if not self.enabled:
            return ConstraintResult.allow()

        # TODO: Implement your constraint logic here

        # Example: Require at least one chunk
        if not chunks:
            return ConstraintResult.deny(
                reason="No supporting evidence found.",
                signal="insufficient_evidence",
            )

        # If checks pass, allow the answer
        return ConstraintResult.allow()
