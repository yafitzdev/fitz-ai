# TEMPLATE: File Reader Plugin
#
# Readers extract content from files and convert to RawDocument objects.
#
# INPUT:  path (Path) - Path to a file OR directory
#
# OUTPUT: Iterable[RawDocument] - Yields document objects
#
# REQUIRED:
#   - plugin_name: str attribute (unique identifier)
#   - ingest() method with signature below
#
# The RawDocument class has these attributes:
#   - path: str (source file path)
#   - content: str (extracted text content)
#   - metadata: Dict[str, Any] (file info, custom fields)
#
# IMPORTANT:
#   - Handle BOTH single files and directories
#   - Use logging for errors, don't raise exceptions
#   - Skip files that can't be processed

from dataclasses import dataclass, field
from pathlib import Path
from typing import Iterable, Set
import logging

from fitz_ai.ingestion.reader.base import RawDocument

logger = logging.getLogger(__name__)


@dataclass
class ReaderTemplate:
    """
    Reader plugins extract content from files.

    Replace 'ReaderTemplate' with your plugin class name.
    Replace 'template_reader' with your plugin_name.
    """

    # REQUIRED: Unique plugin identifier
    plugin_name: str = field(default="template_reader", repr=False)

    # RECOMMENDED: File extensions this reader handles
    # Used by the router to auto-select your plugin
    supported_extensions: Set[str] = field(
        default_factory=lambda: {".txt"}  # Add your extensions
    )

    def ingest(self, path: Path) -> Iterable[RawDocument]:
        """
        Read files and yield RawDocument objects.

        Args:
            path: Path to a file or directory.

        Yields:
            RawDocument for each successfully processed file.
        """
        if path.is_file():
            yield from self._process_file(path)
        else:
            # Process all matching files in directory
            for ext in self.supported_extensions:
                for file_path in path.glob(f"**/*{ext}"):
                    yield from self._process_file(file_path)

    def _process_file(self, file_path: Path) -> Iterable[RawDocument]:
        """Process a single file."""
        try:
            # TODO: Implement your file reading logic here
            content = file_path.read_text(encoding="utf-8")

            if not content.strip():
                logger.debug(f"Skipping empty file: {file_path}")
                return

            yield RawDocument(
                path=str(file_path),
                content=content,
                metadata={
                    "file_extension": file_path.suffix.lower(),
                },
            )

        except Exception as e:
            logger.warning(f"Skipping {file_path}: {type(e).__name__}: {e}")
