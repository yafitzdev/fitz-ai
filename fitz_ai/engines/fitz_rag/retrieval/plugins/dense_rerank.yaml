# fitz_ai/engines/fitz_rag/retrieval/plugins/dense_rerank.yaml
#
# Dense Retrieval with Reranking and Threshold
#
# A sophisticated retrieval pipeline that includes:
# - Artifact fetching (always included with score=1.0)
# - Intelligent vector search (multi-query + keyword filtering baked in)
# - Cross-encoder reranking
# - Top-k selection
# - Score threshold filtering (post-selection)
#
# NOTE: Threshold is applied AFTER limit to preserve diversity.
# This prevents early elimination of logically required documents
# for temporal/causal queries where rerankers optimize for semantic
# similarity rather than logical necessity.

plugin_name: dense_rerank
description: "Dense retrieval with reranking and threshold filtering"

steps:
  - type: artifact_fetch       # Fetch artifacts first (always included)
    enabled_if: fetch_artifacts

  - type: vector_search        # Intelligent vector search (multi-query + keyword baked in)
    k: 40                      # Large candidate pool

  - type: rerank
    k: 15                      # Keep top 15 after reranking
    enabled_if: reranker

  - type: limit
    k: 5
    use_config: top_k

  - type: threshold
    threshold: 0.6             # Filter low-confidence results (post-selection)
    score_key: rerank_score
    fallback_key: vector_score
