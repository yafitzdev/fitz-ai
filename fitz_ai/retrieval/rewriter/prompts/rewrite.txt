Analyze and rewrite this query for optimal document retrieval.
{history_section}
## Current Query
{query}

## Instructions
Perform the following transformations as needed:

1. **Conversational Resolution**: If there's conversation history, resolve any pronouns (it, they, this, that, their) or references to previous topics into explicit terms.

2. **Clarity**: Fix obvious typos, remove filler words (uhh, like, basically, you know), and simplify overly complex phrasing.

3. **Retrieval Optimization**: Convert questions into statement form that matches how documents typically describe things:
   - "What is X?" -> "X definition overview"
   - "How do I Y?" -> "Y procedure steps guide"
   - "Why does Z happen?" -> "Z cause reason explanation"

4. **Compound Query Decomposition**: If the query asks about multiple distinct topics (e.g., "X and also Y", "X, Y, and Z"), decompose it into separate focused queries. Each sub-query should be:
   - Self-contained and searchable independently
   - Specific enough to retrieve relevant documents (avoid generic terms like "pricing" alone)
   - Include the domain/context from the original query (e.g., "car" -> "vehicle" or "electric vehicle")

   Examples:
   - "I need batteries and ranges and prices for cars" -> ["electric vehicle battery capacity specifications", "vehicle driving range miles", "car model pricing cost"]
   - "What is X and how does Y work" -> ["X definition overview", "Y mechanism process"]

5. **Ambiguity Detection**: If the query could have multiple distinct meanings (not just multiple topics), flag it as ambiguous and provide 2-3 possible interpretations.

## Response Format
Return ONLY a JSON object with no additional text:
{{
  "rewritten_query": "the improved single query for retrieval",
  "rewrite_type": "none|conversational|clarity|retrieval|decomposition|combined",
  "confidence": 0.0-1.0,
  "is_compound": true|false,
  "decomposed_queries": ["focused query 1", "focused query 2", "focused query 3"],
  "is_ambiguous": true|false,
  "disambiguated_queries": ["interpretation 1", "interpretation 2"]
}}

Rules:
- If no rewrite is needed, set rewrite_type to "none" and return the original query unchanged
- For compound queries (multiple topics), set is_compound to true and provide focused sub-queries in decomposed_queries
- For ambiguous queries (multiple meanings), set is_ambiguous to true and provide interpretations in disambiguated_queries
- The rewritten_query should be a single optimized query; decomposed_queries contains the separate topic queries
- Keep queries concise but complete
- Preserve the user's core intent
