# fitz_ai/vector_db/plugins/qdrant.yaml
#
# Qdrant Vector Database Plugin
# =============================
#
# Documentation: https://qdrant.tech/documentation/
# API Reference: https://qdrant.github.io/qdrant/redoc/index.html
#
# Supports both local and Qdrant Cloud deployments.
# For cloud: set QDRANT_API_KEY and pass host/port for your cluster.
#
# NOTE: This is updated for Qdrant 1.0+ API which uses "query" instead of "vector"
#       for the search endpoint.

name: qdrant
type: vector_db
description: Qdrant vector database - supports local and cloud deployments

# =============================================================================
# Provider-specific features (drives loader behavior)
# =============================================================================
features:
  # Qdrant requires point IDs to be UUIDs or unsigned 64-bit integers.
  # String IDs like "doc.txt:0" will be converted to deterministic UUIDs.
  requires_uuid_ids: true

  # Enable auto-detection of Qdrant host/port via fitz_ai.core.detect.
  # Uses get_qdrant_connection() which scans localhost and LAN.
  auto_detect: qdrant

  # Qdrant uses collections natively (not namespaces)
  supports_namespaces: false

# =============================================================================
# Connection Configuration
# =============================================================================
connection:
  type: http
  base_url: "http://{{host}}:{{port}}"
  default_host: localhost
  default_port: 6333

  auth:
    type: bearer
    env_var: QDRANT_API_KEY
    header: api-key
    scheme: ""  # Qdrant uses just the key, no "Bearer" prefix
    optional: true  # API key is optional for local deployments

# =============================================================================
# Operations
# =============================================================================
operations:
  # ---------------------------------------------------------------------------
  # Search for similar vectors (Qdrant 1.0+ API)
  # ---------------------------------------------------------------------------
  search:
    endpoint: /collections/{{collection}}/points/query
    method: POST
    body:
      query: "{{query_vector}}"
      limit: "{{limit}}"
      with_payload: "{{with_payload}}"

    response:
      results_path: result.points
      mapping:
        id: id
        score: score
        payload: payload

  # ---------------------------------------------------------------------------
  # Insert or update points
  # ---------------------------------------------------------------------------
  upsert:
    endpoint: /collections/{{collection}}/points
    method: PUT

    # Auto-create collection if it doesn't exist (on 404)
    auto_create_collection: true
    create_collection_endpoint: /collections/{{collection}}
    create_collection_method: PUT
    create_collection_body:
      vectors:
        size: "{{vector_dim}}"
        distance: Cosine

    body:
      points: "{{points}}"

    # No transformation needed - standard format matches Qdrant
    point_transform:
      identity: true

  # ---------------------------------------------------------------------------
  # Count points in collection
  # ---------------------------------------------------------------------------
  count:
    endpoint: /collections/{{collection}}
    method: GET
    response:
      count_path: result.points_count

  # ---------------------------------------------------------------------------
  # Create a new collection
  # ---------------------------------------------------------------------------
  create_collection:
    endpoint: /collections/{{collection}}
    method: PUT
    body:
      vectors:
        size: "{{vector_size}}"
        distance: Cosine

  # ---------------------------------------------------------------------------
  # Delete entire collection
  # ---------------------------------------------------------------------------
  delete_collection:
    endpoint: /collections/{{collection}}
    method: DELETE
    response:
      success_codes: [200, 404]  # 404 = already deleted, that's fine

  # ---------------------------------------------------------------------------
  # List all collections
  # ---------------------------------------------------------------------------
  list_collections:
    endpoint: /collections
    method: GET
    response:
      collections_path: result.collections
      name_field: name

  # ---------------------------------------------------------------------------
  # Get collection statistics
  # ---------------------------------------------------------------------------
  get_stats:
    endpoint: /collections/{{collection}}
    method: GET
    response:
      stats_path: result