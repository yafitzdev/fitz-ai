# fitz_ai/vector_db/plugins/pinecone.yaml
#
# Pinecone Vector Database Plugin
# ===============================
#
# Documentation: https://docs.pinecone.io/
# API Reference: https://docs.pinecone.io/reference/api/introduction
#
# Pinecone is a managed cloud vector database.
# Required environment variables:
#   - PINECONE_API_KEY: Your Pinecone API key
#
# Required kwargs:
#   - index_name: Your Pinecone index name
#   - project_id: Your Pinecone project ID (from console URL)
#   - environment: Region (e.g., "us-east-1-aws", "gcp-starter")
#
# Note: Pinecone uses "namespaces" within an index instead of collections.
# The "collection" parameter in fitz maps to Pinecone namespace.

name: pinecone
type: vector_db
description: Pinecone vector database - managed cloud service

# =============================================================================
# Provider-specific features
# =============================================================================
features:
  # Pinecone accepts any string as ID
  requires_uuid_ids: false

  # Cloud service - no auto-detection
  auto_detect: null

  # Pinecone uses namespaces within an index
  supports_namespaces: true

# =============================================================================
# Connection Configuration
# =============================================================================
connection:
  type: http
  # Pinecone URL format: https://{index}-{project}.svc.{environment}.pinecone.io
  base_url: "https://{{index_name}}-{{project_id}}.svc.{{environment}}.pinecone.io"
  default_environment: us-east-1-aws

  auth:
    type: custom
    env_var: PINECONE_API_KEY
    header: Api-Key
    optional: false

# =============================================================================
# Operations
# =============================================================================
operations:
  # ---------------------------------------------------------------------------
  # Search for similar vectors
  # ---------------------------------------------------------------------------
  search:
    endpoint: /query
    method: POST
    body:
      namespace: "{{collection}}"
      vector: "{{query_vector}}"
      topK: "{{limit}}"
      includeMetadata: "{{with_payload}}"

    response:
      results_path: matches
      mapping:
        id: id
        score: score
        payload: metadata

  # ---------------------------------------------------------------------------
  # Insert or update points (vectors)
  # ---------------------------------------------------------------------------
  upsert:
    endpoint: /vectors/upsert
    method: POST

    # Pinecone doesn't support auto-create - index must exist
    auto_create_collection: false

    body:
      namespace: "{{collection}}"
      vectors: "{{points}}"

    # Transform standard format to Pinecone format
    # Standard: {id, vector, payload}
    # Pinecone: {id, values, metadata}
    point_transform:
      id: id
      values: vector
      metadata: payload

  # ---------------------------------------------------------------------------
  # Count vectors in namespace
  # ---------------------------------------------------------------------------
  count:
    endpoint: /describe_index_stats
    method: POST
    body: {}
    response:
      # Pinecone returns stats per namespace
      # We'll need special handling in the loader for this
      count_path: namespaces.{{collection}}.vectorCount

  # ---------------------------------------------------------------------------
  # Delete namespace (all vectors in namespace)
  # ---------------------------------------------------------------------------
  delete_collection:
    endpoint: /vectors/delete
    method: POST
    body:
      namespace: "{{collection}}"
      deleteAll: true
    response:
      success_codes: [200]

  # ---------------------------------------------------------------------------
  # List namespaces (via describe_index_stats)
  # ---------------------------------------------------------------------------
  list_collections:
    endpoint: /describe_index_stats
    method: POST
    body: {}
    response:
      # Returns dict of namespaces - need special handling to extract keys
      collections_path: namespaces
      # For dict, we extract keys instead of name_field
      extract_keys: true

  # ---------------------------------------------------------------------------
  # Get namespace statistics
  # ---------------------------------------------------------------------------
  get_stats:
    endpoint: /describe_index_stats
    method: POST
    body: {}
    response:
      stats_path: namespaces.{{collection}}